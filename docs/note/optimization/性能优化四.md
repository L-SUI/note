# æ€§èƒ½ä¼˜åŒ–ç¯‡(å››)

## NodeJSæ€§èƒ½ä¼˜åŒ–

- å†…å­˜å›æ”¶ 
- å†…å­˜å¿«ç…§ 
- å‹åŠ›æµ‹è¯• 
- ç›‘æ§å¼‚å¸¸

## å†…å­˜æ³„æ¼çš„æ¦‚å¿µå’Œé€ æˆçš„å½±å“

### å†…å­˜æ³„æ¼

![1595818508000_3A76AB3A-E101-47D1-8884-AB00F96ED751](/optimization/1595818508000_3A76AB3A-E101-47D1-8884-AB00F96ED751.png)

```html
<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8" />
    <title>å¯¹è±¡çš„æ¢ç´¢</title>
  </head>

  <body>
    <script type="text/javascript">
      // 1.ç„¶åé€‰æ‹©â€œMemoryâ€æ ‡ç­¾ï¼Œç‚¹å‡»"take snapshot" è·å–V8çš„å †å†…å­˜å¿«ç…§ã€‚
      // 2:ç„¶åâ€œcommand+f"(mac) æœç´¢â€œsetNameâ€ï¼ŒsetNameå¯¹è±¡ä¸‹é¢åŒ…å«äº†shared
      // 3.raw_outer_scope_info_or_feedback_metadataï¼Œå¯¹é—­åŒ…çš„å¼•ç”¨æ•°æ®å°±åœ¨è¿™é‡Œé¢ã€‚
      function foo() {
        var myName = 'ä¸œ';
        var innerBar = {
          setName: function (newName) {
            myName = newName;
          },
        };
        return innerBar;
      }
      var bar = foo();
      bar.setName('ä¸œğŸ®');
    </script>
  </body>
</html>

```



### å…·ä½“è¡¨ç°

![1595818610190_91152B84-F801-4515-A79F-40172BDEC929](/optimization/1595818610190_91152B84-F801-4515-A79F-40172BDEC929.png)

![6A19DECF-4882-4944-B7D6-00AC85CF7605](/optimization/6A19DECF-4882-4944-B7D6-00AC85CF7605.jpg)

## å‹åŠ›æµ‹è¯•å¯»æ‰¾å†…å­˜æ³„æ¼

### æµ‹è¯•å·¥å…·

**wrk**

![1595818906499_6903C6A1-20AF-4D70-9AF8-9E274B614F37](/optimization/1595818906499_6903C6A1-20AF-4D70-9AF8-9E274B614F37.png)

[wrkGITHUBåœ°å€](https://github.com/wg/wrk)

[å…³äºmake](https://www.ruanyifeng.com/blog/2015/02/make.html)

```javascript
//package.json
{
  "name": "nodedemo",
  "version": "1.0.0",
  "description": "",
  "main": "demo1.js",
  "scripts": {//ä½¿ç”¨makeå‘½ä»¤ç”Ÿæˆwrkæ–‡ä»¶
    "test": "./wrk -t12 -c200 -d 60s http://127.0.0.1:3000"
  },//tçº¿ç¨‹  ç”¨äº†3ä¸ªæ ¸ï¼Œæ¯ä¸ªå››ä¸ªçº¿ç¨‹
  "keywords": [],
  "author": "",
  "license": "ISC"
}

//js
const http = require('http');

let s = '';
for (let i = 0; i < 1024 * 10; i++) {
  s += 'a';
}

const str = s;
const buffStr = Buffer.from(s);//å®éªŒç»“æœæå‡20%å·¦å³

const server = http.createServer((req, res) => {
  if (req.url == '/buffer') {
    res.end(buffStr);
  } else if (req.url == '/string') {
    res.end(str);
  }
});
server.listen(3002);

```

**jMeter**

![1595818991477_24F29A53-C868-4E45-B5ED-EB4F4863E719](/optimization/1595818991477_24F29A53-C868-4E45-B5ED-EB4F4863E719.png)

**nodeè‡ªå¸¦çš„**

![1595819092976_B900B089-1EF5-4A1E-AFFB-A8C8E8FF73C0](/optimization/1595819092976_B900B089-1EF5-4A1E-AFFB-A8C8E8FF73C0.png)

### å…¶ä»–æŸ¥æ‰¾å†…å­˜æ³„æ¼çš„å·¥å…·

![1595819204112_B1DDA4E5-441C-4AB0-BE25-D858DAE1E629](/optimization/1595819204112_B1DDA4E5-441C-4AB0-BE25-D858DAE1E629.png)

![1595819407314_4942539B-EE88-4931-B01C-75BBB2D60A70](/optimization/1595819407314_4942539B-EE88-4931-B01C-75BBB2D60A70.png)

## å¼•èµ·å†…å­˜æ³„æ¼çš„åŸå› åŠç¼–ç è§„èŒƒ

### memeye

```bash
yarn add memeye -D   
#æˆ–è€…
npm i  memeye -D
```

![1595836787890_CD3A47C3-3AC6-4E33-B755-20D527207801](/optimization/1595836787890_CD3A47C3-3AC6-4E33-B755-20D527207801.png)

```javascript
const http = require('http');
const memeye = require('memeye');
memeye();
let leakArray = [];
// leakArray = null;
const server = http.createServer((req, res) => {
  if (req.url == '/') {
    // const wm = new WeakMap();
    leakArray.push(Math.random());
    // wm.set(leakArray, leakArray);
    // console.log(wm.get(leakArray));
    console.log(leakArray);
    // leakArray = null;
    res.end('hello world');
  }
});
server.listen(3000);

```

```bash
#è®¿é—®æ¥å£
yarn test
```

![1595836939976_B693C12D-E542-48AA-97FF-5AC08969BBF5](/Users/liuxiaodong/Desktop/blog/note/docs/.vuepress/public/optimization/1595836939976_B693C12D-E542-48AA-97FF-5AC08969BBF5.png)

çº¢çº¿ä¼šå±…é«˜ä¸ä¸‹ï¼Œä¸€ç›´å¢é•¿ï¼Œè§£å†³çœ‹ä¸‹ä¸€å°èŠ‚node --expose-gc 

### node --expose-gc 

```javascript
global.gc();
//è¿”å›å½“å‰Node.jsä½¿ç”¨æƒ…å†µ
console.log('ç¬¬ä¸€æ¬¡', process.memoryUsage());

let map = new Map();
let key = new Array(5 * 1024 * 1024);
map.set(key, 1);
global.gc();
console.log('ç¬¬äºŒæ¬¡', process.memoryUsage());

key = null;
console.log('ç¬¬ä¸‰æ¬¡', process.memoryUsage());

map.delete(key);
key = null;
global.gc();
// console.log('ç¬¬ä¸‰æ¬¡', process.memoryUsage());
console.log('ç¬¬å››æ¬¡', process.memoryUsage());
```

```bash
node --expose-gc demo3.js 
ç¬¬ä¸€æ¬¡ {
  rss: 19636224,
  heapTotal: 4644864,
  heapUsed: 1767296,
  external: 761096,
  arrayBuffers: 9382
}
ç¬¬äºŒæ¬¡ {
  rss: 62472192,
  heapTotal: 49217536,
  heapUsed: 44176880,
  external: 918630,
  arrayBuffers: 9382
}
ç¬¬ä¸‰æ¬¡ {
  rss: 62664704,
  heapTotal: 49217536,
  heapUsed: 44195880,
  external: 918630,
  arrayBuffers: 9382
}
ç¬¬å››æ¬¡ {
  rss: 62787584,
  heapTotal: 11464704,
  heapUsed: 2234472,
  external: 918630,
  arrayBuffers: 9382
}
```

mapæœ‰å¼•ç”¨ï¼ˆå¼ºå¼•ç”¨ï¼‰ï¼Œå³ä½¿ç½®æˆnullä¹Ÿä¸ä¼šç«‹é©¬æ‰§è¡Œgc

```javascript
global.gc();
//è¿”å›å½“å‰Node.jsä½¿ç”¨æƒ…å†µ
console.log('ç¬¬ä¸€æ¬¡', process.memoryUsage());

const wm = new WeakMap();
let key = new Array(5 * 1024 * 1024);
wm.set(key, 1);
key = null;
global.gc();
console.log('ç¬¬äºŒæ¬¡', process.memoryUsage());

//è¾“å‡º
ç¬¬ä¸€æ¬¡ {
  rss: 19521536,
  heapTotal: 4644864,
  heapUsed: 1767288,
  external: 761096,
  arrayBuffers: 9382
}
ç¬¬äºŒæ¬¡ {
  rss: 20455424,
  heapTotal: 7270400,
  heapUsed: 2233736,
  external: 918630,
  arrayBuffers: 9382
}
```

WeakMapå¯¹å¯¹è±¡å¼±å¼•ç”¨ï¼Œå¯ä»¥ä¸ç”¨åˆ é™¤keyçš„å€¼#

### ç”Ÿæˆlog

![1595838032746_4A7548C3-0E25-49E1-ABB0-AD02142331EF](/optimization/1595838032746_4A7548C3-0E25-49E1-ABB0-AD02142331EF.png)

### é—­åŒ…

![1595838362029_234D1E9E-59C6-43D8-9F88-FF671A0C5A13](/optimization/1595838362029_234D1E9E-59C6-43D8-9F88-FF671A0C5A13.png)

```javascript
function foo () {
  var tem_obj = {
    x: 1,
    y: 2,
    arr: new Array(20000)
  }
  //ç¼“å­˜xï¼Œç”¨è°å­˜è°ï¼Œå‡å°‘å†…å­˜æ³„æ¼
  let closure = tem_obj.x
  return function () {
    console.log(closure)
  }
}
```

### é¢‘å‘çš„åƒåœ¾å›æ”¶è®©GCæ²¡æœ‰æœºä¼šå·¥ä½œ

![1595838665534_577935AF-A4E7-4D08-9B6A-5306D4938E85](/optimization/1595838665534_577935AF-A4E7-4D08-9B6A-5306D4938E85.png)

```js
/**
 *
 */
// function strToArray(str) {
//   let i = 0;
//   const len = str.length;
//   let arr = Array(len);
//   for (; i < len; i++) {
//     arr[i] = str.charCodeAt(i) + Math.random();
//   }
//   return arr;
// }
// function foo() {
//   let i = 0;
//   let str = 'test v8 GC';
//   while (i++ < 10000) {
//     strToArray(str);
//   }
// }
// foo();

function strToArray(str, bufferView) {
  let i = 0;
  const len = str.length;
  for (; i < len; i++) {
    bufferView[i] = str.charCodeAt(i) + Math.random();
  }
  return bufferView;
}
function foo() {
  let i = 0;
  let str = 'test v8 GC';
  // SharedArrayBuffer = è¿ç»­çš„å†…å­˜
  let bufferView = [];
  while (i++ < 10000) {
    strToArray(str, bufferView);
  }
}
foo();

```

```bash
node --trace-gc  ...
#è¾“å‡º
#ä¼˜åŒ–å‰
[55236:0x102d52000]       36 ms: Scavenge 2.4 (3.2) -> 2.0 (4.2) MB, 0.8 / 0.0 ms  (average mu = 1.000, current mu = 1.000) allocation failure 
[55236:0x102d52000]       46 ms: Scavenge 2.5 (4.2) -> 2.2 (5.2) MB, 0.9 / 0.0 ms  (average mu = 1.000, current mu = 1.000) allocation failure 
[55236:0x102d52000]       48 ms: Scavenge 3.1 (5.2) -> 2.1 (7.2) MB, 0.3 / 0.0 ms  (average mu = 1.000, current mu = 1.000) allocation failure 
[55236:0x102d52000]       50 ms: Scavenge 4.1 (7.2) -> 2.1 (7.2) MB, 0.1 / 0.0 ms  (average mu = 1.000, current mu = 1.000) allocation failure
#ä¼˜åŒ–å
[55227:0x102d52000]       37 ms: Scavenge 2.4 (3.2) -> 2.0 (4.2) MB, 0.8 / 0.0 ms  (average mu = 1.000, current mu = 1.000) allocation failure 
[55227:0x102d52000]       46 ms: Scavenge 2.5 (4.2) -> 2.2 (5.0) MB, 0.8 / 0.0 ms  (average mu = 1.000, current mu = 1.000) allocation failure 
[55227:0x102d52000]       50 ms: Scavenge 3.1 (5.0) -> 2.1 (7.0) MB, 0.3 / 0.0 ms  (average mu = 1.000, current mu = 1.000) allocation failur
# è€ç”Ÿä»£æœ‰æœºä¼šå‚ä¸
```

[æ›´å¤šå…³äºSharedArrayBufferæ–¹é¢çš„çŸ¥è¯†è¯·ç‚¹å‡»è¿™é‡Œ](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer)

### å°ç»“

![1595839631984_48F90C05-B208-422D-BCE8-59466F3CCBB5-1](/optimization/1595839631984_48F90C05-B208-422D-BCE8-59466F3CCBB5-1.png)

## domçš„å†…å­˜æ³„æ¼

### dom

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>domå†…å­˜æ³„æ¼</title>
  </head>
  <body>
    <!--åªæœ‰åŒæ—¶æ»¡è¶³ DOM æ ‘å’Œ JavaScript ä»£ç éƒ½ä¸å¼•ç”¨æŸä¸ª DOM èŠ‚ç‚¹ï¼Œè¯¥èŠ‚ç‚¹æ‰ä¼šè¢«ä½œä¸ºåƒåœ¾è¿›è¡Œå›æ”¶ã€‚ 
        å¦‚æœæŸä¸ªèŠ‚ç‚¹å·²ä» DOM æ ‘ç§»é™¤ï¼Œä½† JavaScript ä»ç„¶å¼•ç”¨å®ƒï¼Œæˆ‘ä»¬ç§°æ­¤èŠ‚ç‚¹ä¸ºâ€œdetached â€ã€‚
        å› ä¸º DOM å…ƒç´ ä¾ç„¶ä¼šå‘†åœ¨å†…å­˜ä¸­ã€‚
        â€œdetached â€èŠ‚ç‚¹æ˜¯ DOM å†…å­˜æ³„æ¼çš„å¸¸è§åŸå› ã€‚-->
    <script>
      //ä¸‡ä¸‡è®°å¾—é¿å…å…¨å±€å˜é‡ "use strict"
      //åŒæ—¶ä¹Ÿè¦é¿å…åœ¨å‡½æ•°å†…éƒ¨ä¸ä½¿ç”¨varçš„å£°æ˜
      let detachedTree;
      function create() {
        var ul = document.createElement('ul');
        for (var i = 0; i < 100; i++) {
          var li = document.createElement('li');
          ul.appendChild(li);
        }
        detachedTree = ul;
      }
      create();
      //   detachedTree = null;
    </script>
    <script>
      //æ¸…é™¤å®šæ—¶å™¨â²å¦åˆ™æ°¸è¿œä¼šä¿æŒå¯¹å‡½æ•°çš„å¼•ç”¨
      function setCallback() {
        // 'unpacking' the data object
        let counter = 0;
        const hugeString = new Array(100000).join('x'); // gets removed when the setCallback returns
        return function cb() {
          counter++; // only counter is part of the callback's scope
          console.log(counter);
        };
      }
      const timerId = setInterval(setCallback(), 1000); // saving the interval ID
      clearInterval(timerId); // stopping the timer i.e. if button pressed
    </script>
  </body>
</html>

```

### äº‹ä»¶

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å‰ç«¯å†…å­˜æ³„æ¼ç²’å­2</title>
  </head>
  <body>
    <script>
      // äº‹ä»¶ç›‘å¬å­˜åœ¨äºåŒ¿åå‡½æ•° æ‰€ä»¥ä¹Ÿæ— æ³•ç§»é™¤
      const hugeString = new Array(100000).join('x');
      document.addEventListener('keyup', function () {
        // anonymous inline function - can't remove it
        doSomething(hugeString); // hugeString is now forever kept in the callback's scope
      });

      //ç»ˆåˆ›å»ºæŒ‡å‘äº‹ä»¶ä¾¦å¬å™¨çš„å¼•ç”¨å¹¶å°†å…¶ä¼ é€’ç»™ removeEventListener()ï¼Œæ¥æ³¨é”€ä¸å†éœ€è¦çš„äº‹ä»¶ä¾¦å¬å™¨ã€‚
      function listener() {
        doSomething(hugeString);
      }
      document.addEventListener('keyup', listener); // named function can be referenced here...
      document.removeEventListener('keyup', listener); // ...and here

      //å†æˆ–è€…åˆ›å»ºåªæ‰§è¡Œä¸€æ¬¡çš„ç›‘å¬å‡½æ•°
      document.addEventListener(
        'keyup',
        function listener() {
          doSomething(hugeString);
        },
        { once: true }
      ); // listener will be removed after running once
    </script>
  </body>
</html>

```

### æ¸¸ç¦»çš„domå…ƒç´ 

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ¸¸ç¦»çš„DOMå…ƒç´ 2</title>
  </head>
  <body>
    <script>
      function createElement() {
        const div = document.createElement('div');
        div.id = 'detached';
        return div;
      }
      // this will keep referencing the DOM element even after deleteElement() is called
      const detachedDiv = createElement();
      document.body.appendChild(detachedDiv);
      function deleteElement() {
        document.body.removeChild(document.getElementById('detached'));
      }
      deleteElement(); // Heap snapshot will show detached div#detached
    </script>
    <!--è§£å†³åŠæ³•æ˜¯å°† DOM å¼•ç”¨ç§»å…¥æœ¬åœ°åŸŸã€‚-->
    <script>
      function createElement() {
        // same as above
      }
      // DOM references are inside the function scope
      function appendElement() {
        const detachedDiv = createElement();
        document.body.appendChild(detachedDiv);
      }
      appendElement();
      function deleteElement() {
        document.body.removeChild(document.getElementById('detached'));
      }
      deleteElement(); // no detached div#detached elements in the Heap Snapshot
    </script>
  </body>
</html>

```

### å¯¹è±¡

```html
<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8" />
    <title>å¯¹è±¡çš„æ¢ç´¢</title>
  </head>

  <body>
    <script type="text/javascript">
      // 1.ç„¶åé€‰æ‹©â€œMemoryâ€æ ‡ç­¾ï¼Œç‚¹å‡»"take snapshot" è·å–V8çš„å †å†…å­˜å¿«ç…§ã€‚
      // 2:ç„¶åâ€œcommand+f"(mac) æœç´¢â€œsetNameâ€ï¼ŒsetNameå¯¹è±¡ä¸‹é¢åŒ…å«äº†shared
      // 3.raw_outer_scope_info_or_feedback_metadataï¼Œå¯¹é—­åŒ…çš„å¼•ç”¨æ•°æ®å°±åœ¨è¿™é‡Œé¢ã€‚
      function foo() {
        var myName = 'ä¸œ';
        var innerBar = {
          setName: function (newName) {
            myName = newName;
          },
        };
        return innerBar;
      }
      var bar = foo();
      bar.setName('ä¸œğŸ®');
    </script>
  </body>
</html>

```

## è°ƒè¯•ç¥å™¨

- [https://clinicjs.org/](https://clinicjs.org/)
- [ç¿»è¯‘æ–‡æ¡£](https://youjingyu.github.io/clinic-doc-zh/)

## åŒæ„åŒ–çš„åŸç†

**spa**

vue.js -> vue.router.js -> main.js -> app.js -> vue ç»„ä»¶ ->

æ•°æ® -...js -> äº¤äº’



åˆ‡é¡µçš„æ–¹ä¾¿ a/b -> c/d (å˜åŒ–çš„éƒ¨åˆ†å†…å®¹)



**mpa**

å¯è§å¯æ“ä½œ index.html ç›´æ¥ a å…ƒç´  ç›´æ¥è¾“å‡º

bigpipe main.div -> chunk -> chunk....

--> åŠ è½½ js ä»£ç† a å…ƒç´ 



åç«¯ c/d ç›´æ¥åˆ·æ–°æ¥çš„ ç‚¹è¿‡æ¥çš„ã€‚ä¸€ç‰‡æ®µ æ•´é¡µ



https://www.npmjs.com/package/tti-polyfill

https://www.npmjs.com/package/web-vitals